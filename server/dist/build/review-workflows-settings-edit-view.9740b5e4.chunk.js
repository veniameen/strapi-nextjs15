"use strict";(self.webpackChunkserver=self.webpackChunkserver||[]).push([[277],{63108:(Ee,L,t)=>{t.r(L),t.d(L,{default:()=>oe});var e=t(96540),i=t(78320),g=t(69733),C=t(71526),P=t(90954),h=t(98016),Y=t(10457),p=t(97939),G=t(26437),y=t(7425),U=t(63560),$=t.n(U),J=t(6442),Q=t(75942),X=t(56347),b=t(30420),H=t(30127),Z=t(20022),T=t(45683),f=t(89974),c=t(59984),q=t(45410),_=t(42570),l=t(11714),ee=t(78101),I=t(18960),te=t(41090);function se(){const{workflowId:u}=(0,X.g)(),ne=(0,g.d4)(C.G),{formatMessage:n}=(0,J.A)(),E=(0,g.wA)(),{put:ae}=(0,i.ry)(),{formatAPIError:le}=(0,i.wq)(),A=(0,i.hN)(),{isLoading:D,meta:m,workflows:k,status:W,refetch:re}=(0,ee.W)(),{collectionTypes:ie,singleTypes:ce,isLoading:de}=(0,b.m)(),{status:ge,clientState:{currentWorkflow:{data:a,isDirty:fe,hasDeletedServerStages:R}}}=(0,g.d4)(s=>s?.[l.p6]??I.u),{allowedActions:{canDelete:ue,canUpdate:S}}=(0,i.ec)(ne.settings["review-workflows"]),[w,v]=e.useState({}),{getFeature:me,isLoading:F}=(0,Z.b)(),[O,d]=e.useState(!1),[we,B]=e.useState(null),V=k.find(s=>s.id===parseInt(u,10)),j=k.filter(s=>s.id!==parseInt(u,10)).flatMap(s=>s.contentTypes),{mutateAsync:ve,isLoading:x}=(0,Q.useMutation)(async({workflow:s})=>{const{data:{data:o}}=await ae(`/admin/review-workflows/workflows/${s.id}`,{data:s});return o},{onSuccess(){A({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),he=async s=>{B(null);try{return await ve({workflow:s})}catch(o){return o.response.data?.error?.name==="ValidationError"&&o.response.data?.error?.details?.errors?.length>0&&B(o.response.data?.error?.details?.errors.reduce((z,N)=>($()(z,N.path,N.message),z),{})),A({type:"warning",message:le(o)}),null}},K=async()=>{await he(a),await re(),v({})},pe=async()=>{await K()},ye=()=>{v({})},M=(0,y.Wx)({enableReinitialize:!0,initialErrors:we,initialValues:a,async onSubmit(){const s=a.contentTypes.some(o=>j.includes(o));r?.[l.hK]&&m?.workflowCount>parseInt(r[l.hK],10)?d("workflow"):r?.[l.Dp]&&a.stages.length>parseInt(r[l.Dp],10)?d("stage"):R||s?(R&&v(o=>({...o,hasDeletedServerStages:!0})),s&&v(o=>({...o,hasReassignedContentTypes:!0}))):K()},validate(s){return(0,te._)({values:s,formatMessage:n})}});(0,H.N)(l.p6,I.F);const r=me("review-workflows");return e.useEffect(()=>(E((0,T.yX)({status:W,data:V})),()=>{E((0,T.JU)())}),[W,V,E]),e.useEffect(()=>{!D&&!F&&(r?.[l.hK]&&m?.workflowCount>parseInt(r[l.hK],10)?d("workflow"):r?.[l.Dp]&&a.stages.length>parseInt(r[l.Dp],10)&&d("stage"))},[a.stages.length,F,D,r,m?.workflowCount,m.workflowsTotal]),e.createElement(e.Fragment,null,e.createElement(f.nh,null),e.createElement(y.QI,{value:M},e.createElement(y.lV,{onSubmit:M.handleSubmit},e.createElement(f.Y9,{navigationAction:e.createElement(f.kc,{href:"/settings/review-workflows"}),primaryAction:S&&e.createElement(P.$,{startIcon:e.createElement(G.A,null),type:"submit",size:"M",disabled:!fe,loading:!Object.keys(w).length>0&&x},n({id:"global.save",defaultMessage:"Save"})),subtitle:a.stages.length>0&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:a.stages.length}),title:a.name}),e.createElement(f.bL,null,de||ge==="loading"?e.createElement(h.s,{justifyContent:"center"},e.createElement(Y.a,null,n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"}))):e.createElement(h.s,{alignItems:"stretch",direction:"column",gap:7},e.createElement(_.r,{canUpdate:S,contentTypes:{collectionTypes:ie,singleTypes:ce},currentWorkflow:a,workflows:k}),e.createElement(q.e,{canDelete:ue,canUpdate:S,stages:M.values?.stages}))))),e.createElement(i.TM.Root,{isConfirmButtonLoading:x,isOpen:Object.keys(w).length>0,onToggleDialog:ye,onConfirm:pe},e.createElement(i.TM.Body,null,e.createElement(h.s,{direction:"column",gap:5},w.hasDeletedServerStages&&e.createElement(p.o,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})),w.hasReassignedContentTypes&&e.createElement(p.o,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:j.filter(s=>a.contentTypes.includes(s)).length})),e.createElement(p.o,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"}))))),e.createElement(c.bL,{isOpen:O==="workflow",onClose:()=>d(!1)},e.createElement(c.hE,null,n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})),e.createElement(c.nB,null,n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."}))),e.createElement(c.bL,{isOpen:O==="stage",onClose:()=>d(!1)},e.createElement(c.hE,null,n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})),e.createElement(c.nB,null,n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."}))))}function oe(){const u=(0,g.d4)(C.G);return e.createElement(i.kz,{permissions:u.settings["review-workflows"].main},e.createElement(se,null))}}}]);
